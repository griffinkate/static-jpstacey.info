<!DOCTYPE html>
<html lang="en" version="XHTML+RDFa 1.0" dir="ltr">
<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../../sites/files/jps/starberry_favicon.png" type="image/png" />
<meta name="generator" content="Drupal 7 (https://www.drupal.org)" />
<link rel="canonical" href="including-javascript-behat-tests-all-inside-headless-virtual-machine.html" />
<link rel="shortlink" href="../../node/687.html" />
  <title>Including Javascript in Behat tests, all inside a headless, virtual machine | J-P Stacey</title>
  <link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_xE-rWrJf-fncB6ztZfd2huxqgxu4WO-qwma6Xer30m4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_jdej_Zz2sjg--A2C2aVJ-Qt5W-fI_fkFnsddutilsws.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_A3Qn9PgslsjDpW1HfgFuI26cQlhJ23E7y9wyYqpiJIA.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_0Heb-O6YY5Tn5xG4WrHtAAXZCtYk-eKiVo7PlP1bsg4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_2THG1eGiBIizsWFeexsNe1iDifJ00QRS9uSd03rY9co.css" media="print" />

<!--[if lte IE 7]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie.css?qfgo2z" media="all" />
<![endif]-->

<!--[if IE 6]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie6.css?qfgo2z" media="all" />
<![endif]-->
  <script type="text/javascript" src="../../sites/files/jps/js/js_vDrW3Ry_4gtSYaLsh77lWhWjIC6ml2QNkcfvfP5CVFs.js"></script>
<script type="text/javascript" src="../../sites/files/jps/js/js_gPqjYq7fqdMzw8-29XWQIVoDSWTmZCGy9OqaHppNxuQ.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create", "UA-4775024-1", {"cookieDomain":"auto"});ga("set", "anonymizeIp", true);ga("send", "pageview");
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"barthes","theme_token":"-xCxUrGz7re-2N0MQzK0UA3LdQ8OWsg8agZ1qdA4FpY","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/google_analytics\/googleanalytics.js":1,"0":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"sites\/all\/modules\/date\/date_api\/date.css":1,"sites\/all\/modules\/date\/date_popup\/themes\/datepicker.1.7.css":1,"modules\/field\/theme\/field.css":1,"sites\/all\/modules\/mollom\/mollom.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/media\/modules\/media_wysiwyg\/css\/media_wysiwyg.base.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"public:\/\/geshi\/geshifilter-languages.css":1,"sites\/all\/modules\/geshifilter\/geshifilter.css":1,"themes\/bartik\/css\/layout.css":1,"themes\/bartik\/css\/style.css":1,"sites\/default\/themes\/custom\/barthes\/css\/colors.css":1,"sites\/default\/themes\/custom\/barthes\/css\/custom.css":1,"themes\/bartik\/css\/print.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie6.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc(x|m)?|dot(x|m)?|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt(x|m)?|pot(x|m)?|pps(x|m)?|ppam|sld(x|m)?|thmx|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls(x|m|b)?|xlt(x|m)|xlam|xml|z|zip"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in one-sidebar sidebar-second page-node page-node- page-node-687 node-type-blog" >
  <div id="skip-link">
    <a href="including-javascript-behat-tests-all-inside-headless-virtual-machine.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="page-wrapper"><div id="page">

  <div id="header" class="with-secondary-menu"><div class="section clearfix">

    
          <div id="name-and-slogan">

                              <div id="site-name">
              <strong>
                <a href="../../index.html" title="Home" rel="home"><span>J-P Stacey</span></a>
              </strong>
            </div>
                  
                  <div id="site-slogan">
            Drupal, programming culture, gardening, cycling and the environment          </div>
        
      </div> <!-- /#name-and-slogan -->
    
    
    
          <div id="secondary-menu" class="navigation">
        <h2 class="element-invisible">Secondary menu</h2><ul id="secondary-menu-links" class="links inline clearfix"><li class="menu-7322 first"><a href="../../cv.html" title="My curriculum vitae">CV</a></li>
<li class="menu-7320 last"><a href="../../contact.html" title="">Contact me</a></li>
</ul>      </div> <!-- /#secondary-menu -->
    
  </div></div> <!-- /.section, /#header -->

  
  
  <div id="main-wrapper" class="clearfix"><div id="main" class="clearfix">

    
    
    <div id="content" class="column"><div class="section">
            <a id="main-content"></a>
                    <h1 class="title" id="page-title">
          Including Javascript in Behat tests, all inside a headless, virtual machine        </h1>
                          <div class="tabs">
                  </div>
                          <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div  class="ds-1col node node-blog node-promoted node-full view-mode-full clearfix">

  
  <div class="field field-name-post-date field-type-ds field-label-hidden"><div class="field-items"><div class="field-item even">Tuesday, May 30, 2017 - 16:51</div></div></div><div class="field field-name-field-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>A couple of years ago now, I rather blithely explained how you can <a href="http://www.jpstacey.info/blog/2015-11-30/get-working-behaviour-driven-test-suite-under-ten-minutes">get a working Behat test suite, to implement behavioural-driven development, in under ten minutes</a>. That's all still true, but it's very much in the context of Javascript-free, CSS-free browsing: basically, testing what a robot might see if it visited your website. While that can test a lot of functionality, there's also key elements to any website that can't be tested without seeing how they look and behave in a "real" browser.</p>
<p>In theory, <a href="http://docs.behat.org/en/v2.5/cookbook/behat_and_mink.html">Behat's documentation makes Javascript support seem simple</a>: just tag your scenario with "@javascript". But all of this assumes a technical stack behind every test, that you've already set up. There are a number of different ways of wiring up Behat to such a "real" browser, but often other requirements prevent one or some of them from being used.</p>
<p>Below is a summary of some of the choices I had to make, to get Javascript tests working in my own environment. I'm not presenting it as a definitive "howto", because I'm sure if I did it again, I'd do some bits of it differently: but it should provide some examples of problems you might run into, and some diagnostics and workarounds that might help you proceed. </p>
<h3>If your hardware (emulated or otherwise) lacks a graphical display</h3>
<p>For example, my own development and testing all happens in a virtual machine (VM) managed by Vagrant and Virtualbox. This VM doesn't have a screen as such: it's "headless", meaning it not only doesn't have an emulated monitor, but also (without further installation and configuration) has no software that might manage even a virtual "fake" display. This means that, even if a browser as a user might understand it could be fired up, and then led through a set of tasks, it might be incapable of carrying out those tasks and reporting back, because the website has nowhere to be rendered.</p>
<p>Under Linux, the longstanding monitor control system of choice is X (Windows). A headless version of this exists, to "fake" a display, called X Virtual Framebuffer or <a href="https://en.wikipedia.org/wiki/Xvfb">Xvfb</a>. The choice of browser for testing can also determine other library requirements, as we'll see below.</p>
<p><span style="font-size: 13.008px;">(If you're not running tests headlessly, but just on your own local laptop, </span><a href="https://michaelheap.com/behat-selenium2-webdriver-with-minkextension/" style="font-size: 13.008px;">integration is much more straightforward!</a><span style="font-size: 13.008px;">)</span></p>
<h3>If your operating system is already specified</h3>
<p>My current project has specific hosting requirements, which in turn limit how the VM has to behave. This means the VM must run Debian Jessie. As I'd already decided to try testing using the Firefox browser, its most recent versions were not compatible with Jessie's <a href="https://packages.debian.org/source/jessie/gtk+3.0">pre-built packages for GTK 3.0</a>. This limitation meant that <a href="https://support.mozilla.org/en-US/questions/1121133">the maximum Firefox version that would work was 45</a>, which I found was most stable under GTK 2.x.</p>
<h3>If your browser version is now specified</h3>
<p>With a particular browser version in mind, Behat needs to connect to it. I use Selenium, a Java application (and hence need a JRE too). But the Selenium version needs to be compatible with the Firefox version, so it can talk to the correct Firefox APIs: otherwise, you'll get errors along the lines of:</p>
<pre>
Unable to connect to host 127.0.0.1 on port 7055 after 45000 ms.</pre><p>Followed by <a href="https://github.com/seleniumhq/selenium-google-code-issue-archive/issues/7819">a long debug output</a>. This is a signal that <a href="https://stackoverflow.com/questions/25300690/unable-to-connect-to-host-127-0-0-1-on-port-7055-after-45000-ms-with-ff-version">Selenium needs to be a different version</a> (usually an older one, if like me you're on Firefox 45!) But at this late stage, different Selenium JARs can be evaluated by trial and error.</p>
<h3>The result</h3>
<p>Other combinations of packages might also work, but here's one working set of package versions that does:</p>
<ul><li><strong>Operating system:</strong> Debian Jessie</li>
<li><strong>Graphical emulation: </strong>Xvfb, libgtk2.0-0, libasound2 (Firefox needs virtual audio too)</li>
<li><strong>Behat-to-browser connections: </strong>Selenium 2.53.1, OpenJDK 7 JRE (headless)</li>
</ul><h3>Automated provisioning with Ansible</h3>
<p>I provision my VMs with Ansible where possible, so here's an Ansible tasks file describing the above:</p>
<pre>
- name: Get Firefox headless, OpenJDK JRE and XVFB
  apt: "name={{ item }} state=latest"
  with_items:
    - openjdk-7-jre-headless
    - xvfb
    - libgtk2.0-0
    - libasound2

- name: Download Firefox at a particular version compatible with gtk&lt;3.2 and Selenium 2.53.1.
  unarchive:
    src: https://ftp.mozilla.org/pub/firefox/releases/45.0.1esr/linux-x86_64/en-GB/firefox-45.0.1esr.tar.bz2
    dest: /opt
    remote_src: true

- name: Symlink Firefox executable.
  file: src=/opt/firefox/firefox dest=/usr/bin/firefox state=link

- name: Create folder to contain Selenium jar.
  file: path=/opt/selenium state=directory mode=0755

- name: Download Selenium jar compatible with Firefox 45.
  shell: |
    wget -O /opt/selenium/selenium.jar http://selenium-release.storage.googleapis.com/2.53/selenium-server-standalone-2.53.1.jar
  args:
    creates: /opt/selenium/selenium.jar

# @see https://blog.vandenbrand.org/2014/11/05/install-selenium-headless-on-debian-wheezy-optionally-with-ansible/
- name: Create selenium as a service.
  copy: src=templates/etc-init.d-selenium.j2 dest=/etc/init.d/selenium mode=0755

- name: Start Selenium as a service.
  shell: /etc/init.d/selenium restart</pre><p>You also need Xvfb to be started as a service, so it's already running by the time the Behat tests run. I adapted <a href="https://blog.vandenbrand.org/2014/11/05/install-selenium-headless-on-debian-wheezy-optionally-with-ansible/">this example init script</a> to emulate a much bigger monitor, so that I can test behaviours on desktop-sized displays:</p>
<pre>
### BEGIN INIT INFO
# Provides:          selenium
# Required-Start:    $local_fs $network
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: selenium
# Description:       selenium with xvfb
### END INIT INFO
 
XVFB="/usr/bin/xvfb-run"
PIDFILE=/var/run/xvfb.pid
case "$1" in
  start)
    echo -n "Starting virtual X frame buffer: Xvfb"
    start-stop-daemon --start --quiet --pidfile $PIDFILE --make-pidfile --background --exec $XVFB -- -s '-screen 0 1280x1024x8' java -jar /opt/selenium/selenium.jar
    echo "."
    ;;
  stop)
    echo -n "Stopping virtual X frame buffer: Xvfb"
    # does not work with start-stop-daemon because of child processes
    read pid &lt;$PIDFILE
    pkill -TERM -P $pid
    echo "."
    ;;
  restart)
    $0 stop
    $0 start
    ;;
  *)
        echo "Usage: /etc/init.d/selenium {start|stop|restart}"
        exit 1
esac
 
exit 0</pre><p> </p>
<p>This can be saved in a templates folder alongside the Ansible YAML file in the tasks folder.</p>
<h3>Summary</h3>
<p>Behat Javascript integration, once it's set up, is very straightforward and stable. But depending on the limitations of your existing environment, the chain of Behat–Selenium–browser–display can be very picky about the versions of each element of the chain. Above is a recipe that works, although others might work too.</p>
<p>Ultimately the increase in test coverage is definitely worth it—it shook out some bugs for us that weren't testable any other way!—but expect it to take some time to get it working first.</p>
</div></div></div><div id="comments" class="comment-wrapper">
  
  
  </div>
</div>

  </div>
</div>
  </div>
      
    </div></div> <!-- /.section, /#content -->

          <div id="sidebar-second" class="column sidebar"><div class="section">
          <div class="region region-sidebar-second">
    <div id="block-block-7" class="block block-block">

    <h2>I&#039;m a Drupal Association member!</h2>
  
  <div class="content">
    <div style="margin: -15px 0"><a href="https://drupal.org/user/130486"><img src="https://association.drupal.org/files/Drupal_Association_ind_member_217_0.png" alt="My individual membership of the Drupal Association" title="You can view my DA membership on drupal.org" width="168" height="168" /></a></div>
  </div>
</div>
<div id="block-block-10" class="block block-block">

    <h2>Drupal 8 API tutorials</h2>
  
  <div class="content">
    <p>Want to learn about the Drupal 8 APIs, with worked examples? <a href="http://www.jpstacey.info/d8api">Follow my series of tutorials</a>, covering routing, caching, entities, config and much more!</p>
  </div>
</div>
<div id="block-stateblock-stateblock" class="block block-stateblock">

    <h2>Want to hire me?</h2>
  
  <div class="content">
    <a href="../../contact.html"><section class="state-no">
  <header>I'm currently</header>
  <section class="state-description">fully booked</section>
  <footer>for freelance work. But you can click here to contact me!</footer>
</section></a>  </div>
</div>
<div id="block-ds-extras-blogpost-secondary-nav" class="block block-ds-extras">

    
  <div class="content">
    <div class="field field-name-taxonomy-vocabulary-6 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Blog category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-category/subtleties.html">subtleties</a>, <a href="../../category/wordpress-category/tutorials.html">tutorials</a></li></ul></div><div class="field field-name-taxonomy-vocabulary-7 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Tags: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/tags/bdd.html">bdd</a>, <a href="../../category/tags/behat.html">behat</a>, <a href="../../category/wordpress-tag/testing.html">testing</a></li></ul></div>  </div>
</div>
<div id="block-views-recent-blog-block-1" class="block block-views">

    <h2>Recent blogposts</h2>
  
  <div class="content">
    <div class="view view-recent-blog view-id-recent_blog view-display-id-block_1 view-dom-id-6b24cb4b1eb9112c62c14152401c515b">
        
  
  
      <div class="view-content">
        <ul>
    <li class="first odd">
      
      <h3>
  
    
      <a href="../2017-07-21/altering-length-drupal-8-text-field-contains-data.html">Altering the length of a Drupal 8 text field that contains data</a>
      </h3>
  

      <div>
  
    
      Friday, July 21, 2017 - 11:31
      </div>
  
    </li>
      <li class="even">
      
      <h3>
  
    
      <a href="../2017-06-02/menagerie-testing-behavioural-unit-system-smoke-regression-oh-my.html">A menagerie of testing: behavioural, unit, system, smoke, regression, oh my!</a>
      </h3>
  

      <div>
  
    
      Friday, June 2, 2017 - 10:11
      </div>
  
    </li>
      <li class="last odd">
      
      <h3>
  
    
      <a href="including-javascript-behat-tests-all-inside-headless-virtual-machine.html" class="active">Including Javascript in Behat tests, all inside a headless, virtual machine</a>
      </h3>
  

      <div>
  
    
      Tuesday, May 30, 2017 - 16:51
      </div>
  
    </li>
    </ul>
    </div>
  
  
  
      
<div class="more-link">
  <a href="../../blog_view.html">
    All blogposts  </a>
</div>
  
  
  
</div>  </div>
</div>
<div id="block-block-5" class="block block-block">

    <h2>About me</h2>
  
  <div class="content">
    <p>I'm J-P Stacey, and I'm a freelance technical developer and software architect, working with <a href="http://drupal.org/">Drupal</a>, Javascript, Symfony, PHP and devops, with experience in project and process management and an emphasis on usability.</p>
<p>I live in the <a href="http://gov.uk">UK</a>; my website is self-hosted on <a href="http://bigv.io">bigv.io</a>; my email is hosted by <a href="http://mail.google.com">Google</a>, and that's also what I use to share files. <small>(<a href="https://data-jurisdiction.org/country/GB">More info</a>|<a href="http://www.jpstacey.info/blog/2013-08-20/what-jurisdiction-am-i-in">What is this?</a>)</small></p>
  </div>
</div>
<div id="block-menu-secondary-menu" class="block block-menu">

    <h2>Find me elsewhere</h2>
  
  <div class="content">
    <ul class="menu clearfix"><li class="first leaf"><a href="http://twitter.com/mphield" title="My commercial account on Twitter">Company @ Twitter</a></li>
<li class="leaf"><a href="http://drupal.org/user/130486" title="Drupal user #130486: woohoo!">Drupal @ d.o</a></li>
<li class="leaf"><a href="http://github.com/jpstacey" title="My code repositories on Github">Code @ Github</a></li>
<li class="leaf"><a href="http://flickr.com/photos/eustatius" title="My photos on Flickr">Photos @ Flickr</a></li>
<li class="last leaf"><a href="http://pinboard.in/u:jpstacey" title="My links on the Pinboard bookmarking site">Links @ Pinboard</a></li>
</ul>  </div>
</div>
  </div>
      </div></div> <!-- /.section, /#sidebar-second -->
    
  </div></div> <!-- /#main, /#main-wrapper -->

  
  <div id="footer-wrapper"><div class="section">

    
    
  </div></div> <!-- /.section, /#footer-wrapper -->

</div></div> <!-- /#page, /#page-wrapper -->
  </body>
</html>
