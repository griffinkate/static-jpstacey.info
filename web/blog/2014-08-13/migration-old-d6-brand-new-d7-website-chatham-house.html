<!DOCTYPE html>
<html lang="en" version="XHTML+RDFa 1.0" dir="ltr">
<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../../sites/files/jps/starberry_favicon.png" type="image/png" />
<meta name="generator" content="Drupal 7 (https://www.drupal.org)" />
<link rel="canonical" href="migration-old-d6-brand-new-d7-website-chatham-house.html" />
<link rel="shortlink" href="../../node/541.html" />
  <title>Migration from old D6 into a brand-new D7 website with Chatham House | J-P Stacey</title>
  <link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_xE-rWrJf-fncB6ztZfd2huxqgxu4WO-qwma6Xer30m4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_jdej_Zz2sjg--A2C2aVJ-Qt5W-fI_fkFnsddutilsws.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_A3Qn9PgslsjDpW1HfgFuI26cQlhJ23E7y9wyYqpiJIA.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_0Heb-O6YY5Tn5xG4WrHtAAXZCtYk-eKiVo7PlP1bsg4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_2THG1eGiBIizsWFeexsNe1iDifJ00QRS9uSd03rY9co.css" media="print" />

<!--[if lte IE 7]>
<link type="text/css" rel="stylesheet" href="/sites/default/themes/custom/barthes/css/ie.css?qfgo2z" media="all" />
<![endif]-->

<!--[if IE 6]>
<link type="text/css" rel="stylesheet" href="/sites/default/themes/custom/barthes/css/ie6.css?qfgo2z" media="all" />
<![endif]-->
  <script type="text/javascript" src="../../sites/files/jps/js/js_vDrW3Ry_4gtSYaLsh77lWhWjIC6ml2QNkcfvfP5CVFs.js"></script>
<script type="text/javascript" src="../../sites/files/jps/js/js_gPqjYq7fqdMzw8-29XWQIVoDSWTmZCGy9OqaHppNxuQ.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create", "UA-4775024-1", {"cookieDomain":"auto"});ga("set", "anonymizeIp", true);ga("send", "pageview");
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"barthes","theme_token":"EptP_ZuElSVTq5YG4hvidZRW_qN_RegGMv6w33VkOug","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/google_analytics\/googleanalytics.js":1,"0":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"sites\/all\/modules\/date\/date_api\/date.css":1,"sites\/all\/modules\/date\/date_popup\/themes\/datepicker.1.7.css":1,"modules\/field\/theme\/field.css":1,"sites\/all\/modules\/mollom\/mollom.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/media\/modules\/media_wysiwyg\/css\/media_wysiwyg.base.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"public:\/\/geshi\/geshifilter-languages.css":1,"sites\/all\/modules\/geshifilter\/geshifilter.css":1,"themes\/bartik\/css\/layout.css":1,"themes\/bartik\/css\/style.css":1,"sites\/default\/themes\/custom\/barthes\/css\/colors.css":1,"sites\/default\/themes\/custom\/barthes\/css\/custom.css":1,"themes\/bartik\/css\/print.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie6.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc(x|m)?|dot(x|m)?|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt(x|m)?|pot(x|m)?|pps(x|m)?|ppam|sld(x|m)?|thmx|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls(x|m|b)?|xlt(x|m)|xlam|xml|z|zip"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in one-sidebar sidebar-second page-node page-node- page-node-541 node-type-blog" >
  <div id="skip-link">
    <a href="migration-old-d6-brand-new-d7-website-chatham-house.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="page-wrapper"><div id="page">

  <div id="header" class="with-secondary-menu"><div class="section clearfix">

    
          <div id="name-and-slogan">

                              <div id="site-name">
              <strong>
                <a href="../../index.html" title="Home" rel="home"><span>J-P Stacey</span></a>
              </strong>
            </div>
                  
                  <div id="site-slogan">
            Drupal, programming culture, gardening, cycling and the environment          </div>
        
      </div> <!-- /#name-and-slogan -->
    
    
    
          <div id="secondary-menu" class="navigation">
        <h2 class="element-invisible">Secondary menu</h2><ul id="secondary-menu-links" class="links inline clearfix"><li class="menu-7322 first"><a href="../../cv.html" title="My curriculum vitae">CV</a></li>
<li class="menu-7320 last"><a href="../../contact.html" title="">Contact me</a></li>
</ul>      </div> <!-- /#secondary-menu -->
    
  </div></div> <!-- /.section, /#header -->

  
  
  <div id="main-wrapper" class="clearfix"><div id="main" class="clearfix">

    
    
    <div id="content" class="column"><div class="section">
            <a id="main-content"></a>
                    <h1 class="title" id="page-title">
          Migration from old D6 into a brand-new D7 website with Chatham House        </h1>
                          <div class="tabs">
                  </div>
                          <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div  class="ds-1col node node-blog node-promoted node-full view-mode-full clearfix">

  
  <div class="field field-name-post-date field-type-ds field-label-hidden"><div class="field-items"><div class="field-item even">Wednesday, August 13, 2014 - 17:32</div></div></div><div class="field field-name-field-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>I collaborated with my old friends Torchbox on getting <a href="http://www.chathamhouse.org/">the new Chatham House website</a> live on Drupal 7; I'm especially relieved that someone there did <a href="https://www.drupal.org/node/2313853">a great case study on drupal.org</a>, so that I don't have to fill in all the details. Go and read that for broader details of the project build, and then come back. Please!</p>
<h2>Using a whitelabel build and deployment tools</h2>
<p>Chatham House were already on Drupal 6, although the build had grown quite tangled - understandably, over several years - and it was time to start afresh. Also, during my time at Torchbox, I built both:</p>
<ol><li><strong>a "whitelabel" Drupal website build:</strong> essentially an extension of a standard <a href="https://www.drupal.org/node/306267">install profile</a>; using a selectable "restaurant menu" of features to install most basic configuration; then extending with custom code to perform cross-feature tying-together e.g. a document management feature, deployed across (and overriding) </li>
<li><strong>a deployment tool for managing Drupal codebases:</strong> a Python tool - "<a href="http://en.wikipedia.org/wiki/Metope_(mythology)">Metope</a>" - which was the precursor to <a href="https://drupal.org/project/drush_instance">Drush instance</a>,  powering both the initial whitelabel build and configuration, and also managing (re-)deployment of the codebase going forwards (using Drush make, naturally!)</li>
</ol><p>These tools make it attractive to start any big "re-"build from scratch - basically a "build" without the "re-" - and so it felt like a great opportunity to move at least the content over from D6 to a completely fresh D7 build, and move forwards with a new, performant, optimized platform for Chatham House's future needs. </p>
<h2>My involvement: D6 to D7 migration</h2>
<p>My work revolved entirely around the <a href="https://www.drupal.org/project/migrate">Migrate</a> and <a href="https://www.drupal.org/project/migrate_d2d">Migrate D2D</a> (Drupal-to-Drupal) modules, extending these to suit both the D6 content, the D7 target structures, and also the tangles of new mappings and new information coming in from other sources during the transfer (typically from CSV.)</p>
<p>You'd think that, as I was working on this project, I might at least have the prospect of nice visuals as I was working, like for example:</p>
<p style="text-align:center"><img alt="" src="https://www.drupal.org/files/The_world620x543_margin_right.png" style="height:420px; width:480px" /></p>
<p>Sadly, my job was to implement the very <em>guts</em> of the content migration process, which means that on a good day I would usually spend a long time staring at screens that looked something like:</p>
<p style="text-align:center"><a href="/sites/files/jps/chatham_house_migration.png"><img alt="" src="http://www.jpstacey.info/sites/files/jps/styles/large/public/chatham_house_migration.png.html" /></a></p>
<p>Other days - most days, in fact - all I would see all day would be the command prompt, multiple copies of gVim, and - if I was lucky - the cat.</p>
<h2>Experiences of Migrate D2D</h2>
<p>Generally, Migrate and Migrate D2D were good to work with. They handled rolling migrations fairly well. The metrics were occasionally useful, although we didn't bother with the field-by-field metrics, as all migrations were checked by eye anyway.</p>
<p>One thing I would recommend is running the migrations from the command prompt using the excellent Drush commands bundled with Migrate: this was less prone to browser-based interruptions, and occasional glitches in the metrics (sometimes metrics came out with negative values in the "unimported" column if migrations were run solely from the browser!)</p>
<p>Some of the trickier problems included:</p>
<ul><li>Working out <strong>what messages to worry about</strong>: messages were very noisy, and could be fired by all sorts of unimportant events; especially by the apachesolr module on dev where Solr wasn'tt present.</li>
<li>Migrating from <strong>D6 files-plus-sometimes-node-wrappers</strong> to D7 media entities and/or files.</li>
<li><strong>Migrating dates</strong> - until you turn Date Migrate on, which nothing warns you about, date migration is patchy. Even then, from/to dates didn't migrate well without either repeat date management in D7 (which we didn't want) or custom code.</li>
<li><strong>Rolling back migrations</strong>: if you weren't careful, related content or media entities would sometimes roll back too, and never be re-migrated.</li>
<li><strong>Duplicate or broken</strong> nodes/references/files in D6: handling those exceptional conditions.</li>
<li><strong>Injecting new information</strong> into the model during migration, from remote CSV or from guesses made about the D6 content ("with this taxonomy, and this title prefix, it's probably...")</li>
<li><strong>Sixty gigabytes of files </strong>in D6. A lot of this could be removed, as it was audio (being migrated to a remote service.) But managing and migrating the <strong>5+GB </strong>remaining, across dev, staging and production, over network connections of varying bandwidth, was still tricky.</li>
<li>Migrating audio wrapper nodes with <strong>faked unique Soundcloud URLs</strong>: because Media requires resources to be unique. Also building a quick interface to edit those URLs after adding, because Media doesn't have one.</li>
<li>Migrating <strong>one D6 node as many D7 nodes</strong>, in order to phase out D6 functionality like flexinode and fit better into the existing D7 whitelabel build.</li>
<li><strong>Sharing code between unrelated migrate classes</strong>: nodes and files had to be migrated using fundamentally different classes, and these had to work in a range of different environments, some of which were using PHP 5.3. That meant traits and interfaces could not be relied upon, and instead shared helper objects were injected as dependencies.</li>
</ul><p>I could go on for ages about these problems and how I solved them, but maybe the best thing is for interested parties to just ask me in the comments.</p>
<h2>Summary</h2>
<p>Using Migrate, rather than upgrading a Drupal site <em>in situ</em> (<a href="/blog/2013-12-22/exercise-staying-same-only-better-drupal-6-7-upgrade-nhs-forest.html">see here for how to use drush sup to do that very thing</a>) was a good way of taking advantage of improvements in D7, rather than having a D7 site that was wedded to understandably dated ways of working.</p>
<p>Media, Features and Display Suite were all improvements that could rapidly be taken advantage of, before you even consider Torchbox's custom install profile and tools. Besides, a lot of the old D6 cruft only made sense in the context of old D6 custom code, which the project determined to clear out in favour of doing things the right way from the outset.</p>
<p>Migrate and Migrate D2D provide a good framework for building D6-to-D7 migrations, and were often helpful in reporting what had gone wrong, if only to move your development back onto the right track. But documentation is quite fragmented, and so experience pays dividends. Expect to build a lot of object-oriented PHP code if you go down this route yourself.</p>
<p>Still, the end result is fantastic, thanks to the frontend and design teams that worked on it. And migrating just the content, and making it D7-shaped along the way - rather than being tied to the old D6 structure - meant that the frontenders were given wings to fly, which (I think it's fair to say) they jolly well did.</p>
</div></div></div><div id="comments" class="comment-wrapper">
          <h2 class="title">Comments</h2>
      
  <a id="comment-232"></a>
<div class="comment comment-by-anonymous clearfix">

  <div class="attribution">

    
    <div class="submitted">
      <p class="commenter-name">
        <a href="http://www.kegel.com" rel="nofollow" class="username">Dan Kegel (not verified)</a>      </p>
      <p class="comment-time">
        Sat, 18/07/2015 - 20:21      </p>
      <p class="comment-permalink">
        <a href="../../comment/232.html#comment-232" class="permalink" rel="bookmark">Permalink</a>      </p>
    </div>
  </div>

  <div class="comment-text">
    <div class="comment-arrow"></div>

    
    <div style='display: none;'>    <h3><a href="../../comment/232.html#comment-232" class="permalink" rel="bookmark">Did you have to handle</a></h3>
    </div>
    <div class="content">
      <div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>Did you have to handle taxonomies?  Were you migrating from a remote machine?  I got stuck because migrate_d2d doesn't seem to allow migrating taxonomies from a remote machine ( <a href="https://www.drupal.org/node/2531872 ">https://www.drupal.org/node/2531872 </a>).  I could just export and import the taxonomies via csv, but then migrate_d2d wouldn't know how to map tid's and vid's when migrating nodes.  </p>
</div></div></div>          </div> <!-- /.content -->

    <ul class="links inline"><li class="comment-reply first last"><a href="../../comment/reply/541/232.html">reply</a></li>
</ul>  </div> <!-- /.comment-text -->
</div>

<div class="indented"><a id="comment-233"></a>
<div class="comment comment-by-node-author clearfix">

  <div class="attribution">

    
    <div class="submitted">
      <p class="commenter-name">
        <span class="username">jp.stacey</span>      </p>
      <p class="comment-time">
        Tue, 21/07/2015 - 08:30      </p>
      <p class="comment-permalink">
        <a href="../../comment/233.html#comment-233" class="permalink" rel="bookmark">Permalink</a>      </p>
    </div>
  </div>

  <div class="comment-text">
    <div class="comment-arrow"></div>

    
    <div style='display: none;'>    <h3><a href="../../comment/233.html#comment-233" class="permalink" rel="bookmark">It&#039;s not at all clear what</a></h3>
    </div>
    <div class="content">
      <div class="field field-name-comment-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>It's not at all clear what you mean by "migrating taxonomies": do you mean migrating each vocabulary "container" for the terms, or the terms themselves? Your link is also broken.</p>
<p>If the former, then no, because there was only half a dozen vocabularies and they were quick to set up in D7 (also, they needed to be rearranged). If the latter, then yes. To migrate terms, you can either:</p>
<ol><li><strong>Migrate node content</strong>, and assign-and-create terms on the fly. This is straightforward but won't e.g. migrate your term hierarchy; and terms are checked for already-existing (within a given vocabulary) by term label, so duplicates in different parts of your original hierarchy could be collapsed down during the migration.</li>
<li><strong>Migrate terms first</strong>, using <a href="https://www.drupal.org/node/1349702">MigrateDestinationTerm</a>. Then treat the term reference field on the node as any other reference field and use -&gt;sourceMigration() to reference your terms migration. Make sure you also add the terms migration as a dependency on your node migration; otherwise, you might accidentally lose some terms.</li>
</ol><p>All of this, by the way, has nothing to do with where the database is stored (remote machine or otherwise): that's handled at a completely different level. If you've managed to get access to the data at that lower level, then Migrate doesn't really care where the data is coming from.</p>
</div></div></div>          </div> <!-- /.content -->

    <ul class="links inline"><li class="comment-reply first last"><a href="../../comment/reply/541/233.html">reply</a></li>
</ul>  </div> <!-- /.comment-text -->
</div>
</div>
  </div>
</div>

  </div>
</div>
  </div>
      
    </div></div> <!-- /.section, /#content -->

          <div id="sidebar-second" class="column sidebar"><div class="section">
          <div class="region region-sidebar-second">
    <div id="block-block-7" class="block block-block">

    <h2>I&#039;m a Drupal Association member!</h2>
  
  <div class="content">
    <div style="margin: -15px 0"><a href="https://drupal.org/user/130486"><img src="https://association.drupal.org/files/Drupal_Association_ind_member_217_0.png" alt="My individual membership of the Drupal Association" title="You can view my DA membership on drupal.org" width="168" height="168" /></a></div>
  </div>
</div>
<div id="block-block-10" class="block block-block">

    <h2>Drupal 8 API tutorials</h2>
  
  <div class="content">
    <p>Want to learn about the Drupal 8 APIs, with worked examples? <a href="/d8api.html">Follow my series of tutorials</a>, covering routing, caching, entities, config and much more!</p>
  </div>
</div>
<div id="block-stateblock-stateblock" class="block block-stateblock">

    <h2>Want to hire me?</h2>
  
  <div class="content">
    <a href="../../contact.html"><section class="state-no">
  <header>I'm currently</header>
  <section class="state-description">fully booked</section>
  <footer>for freelance work. But you can click here to contact me!</footer>
</section></a>  </div>
</div>
<div id="block-ds-extras-blogpost-secondary-nav" class="block block-ds-extras">

    
  <div class="content">
    <div class="field field-name-taxonomy-vocabulary-6 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Blog category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-category/content.html">content</a>, <a href="../../category/wordpress-category/import/export.html">import/export</a>, <a href="../../category/wordpress-category/media.html">media</a></li></ul></div><div class="field field-name-taxonomy-vocabulary-7 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Tags: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-tag/migration.html">migration</a>, <a href="../../category/tags/migrate-d2d.html">migrate-d2d</a>, <a href="../../category/tags/myportfolio.html">myportfolio</a></li></ul></div>  </div>
</div>
<div id="block-views-recent-blog-block-1" class="block block-views">

    <h2>Recent blogposts</h2>
  
  <div class="content">
    <div class="view view-recent-blog view-id-recent_blog view-display-id-block_1 view-dom-id-42132ae9ddc837e114e3726475e5e8a7">
        
  
  
      <div class="view-content">
        <ul>
    <li class="first odd">
      
      <h3>
  
    
      <a href="../2017-07-21/altering-length-drupal-8-text-field-contains-data.html">Altering the length of a Drupal 8 text field that contains data</a>
      </h3>
  

      <div>
  
    
      Friday, July 21, 2017 - 11:31
      </div>
  
    </li>
      <li class="even">
      
      <h3>
  
    
      <a href="../2017-06-02/menagerie-testing-behavioural-unit-system-smoke-regression-oh-my.html">A menagerie of testing: behavioural, unit, system, smoke, regression, oh my!</a>
      </h3>
  

      <div>
  
    
      Friday, June 2, 2017 - 10:11
      </div>
  
    </li>
      <li class="last odd">
      
      <h3>
  
    
      <a href="../2017-05-30/including-javascript-behat-tests-all-inside-headless-virtual-machine.html">Including Javascript in Behat tests, all inside a headless, virtual machine</a>
      </h3>
  

      <div>
  
    
      Tuesday, May 30, 2017 - 16:51
      </div>
  
    </li>
    </ul>
    </div>
  
  
  
      
<div class="more-link">
  <a href="../../blog_view.html">
    All blogposts  </a>
</div>
  
  
  
</div>  </div>
</div>
<div id="block-block-5" class="block block-block">

    <h2>About me</h2>
  
  <div class="content">
    <p>I'm J-P Stacey, and I'm a freelance technical developer and software architect, working with <a href="http://drupal.org/">Drupal</a>, Javascript, Symfony, PHP and devops, with experience in project and process management and an emphasis on usability.</p>
<p>I live in the <a href="http://gov.uk">UK</a>; my website is self-hosted on <a href="http://bigv.io">bigv.io</a>; my email is hosted by <a href="http://mail.google.com">Google</a>, and that's also what I use to share files. <small>(<a href="https://data-jurisdiction.org/country/GB">More info</a>|<a href="/blog/2013-08-20/what-jurisdiction-am-i-in.html">What is this?</a>)</small></p>
  </div>
</div>
<div id="block-menu-secondary-menu" class="block block-menu">

    <h2>Find me elsewhere</h2>
  
  <div class="content">
    <ul class="menu clearfix"><li class="first leaf"><a href="http://twitter.com/mphield" title="My commercial account on Twitter">Company @ Twitter</a></li>
<li class="leaf"><a href="http://drupal.org/user/130486" title="Drupal user #130486: woohoo!">Drupal @ d.o</a></li>
<li class="leaf"><a href="http://github.com/jpstacey" title="My code repositories on Github">Code @ Github</a></li>
<li class="leaf"><a href="http://flickr.com/photos/eustatius" title="My photos on Flickr">Photos @ Flickr</a></li>
<li class="last leaf"><a href="http://pinboard.in/u:jpstacey" title="My links on the Pinboard bookmarking site">Links @ Pinboard</a></li>
</ul>  </div>
</div>
  </div>
      </div></div> <!-- /.section, /#sidebar-second -->
    
  </div></div> <!-- /#main, /#main-wrapper -->

  
  <div id="footer-wrapper"><div class="section">

    
    
  </div></div> <!-- /.section, /#footer-wrapper -->

</div></div> <!-- /#page, /#page-wrapper -->
  </body>
</html>
