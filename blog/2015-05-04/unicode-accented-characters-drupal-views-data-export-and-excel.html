<!DOCTYPE html>
<html lang="en" version="XHTML+RDFa 1.0" dir="ltr">
<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../../sites/files/jps/starberry_favicon.png" type="image/png" />
<meta name="generator" content="Drupal 7 (https://www.drupal.org)" />
<link rel="canonical" href="unicode-accented-characters-drupal-views-data-export-and-excel.html" />
<link rel="shortlink" href="../../node/593.html" />
  <title>Unicode, accented characters, Drupal Views Data Export and Excel | J-P Stacey</title>
  <link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_xE-rWrJf-fncB6ztZfd2huxqgxu4WO-qwma6Xer30m4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_jdej_Zz2sjg--A2C2aVJ-Qt5W-fI_fkFnsddutilsws.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_A3Qn9PgslsjDpW1HfgFuI26cQlhJ23E7y9wyYqpiJIA.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_0Heb-O6YY5Tn5xG4WrHtAAXZCtYk-eKiVo7PlP1bsg4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_2THG1eGiBIizsWFeexsNe1iDifJ00QRS9uSd03rY9co.css" media="print" />

<!--[if lte IE 7]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie.css?qfgo2z" media="all" />
<![endif]-->

<!--[if IE 6]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie6.css?qfgo2z" media="all" />
<![endif]-->
  <script type="text/javascript" src="../../sites/files/jps/js/js_vDrW3Ry_4gtSYaLsh77lWhWjIC6ml2QNkcfvfP5CVFs.js"></script>
<script type="text/javascript" src="../../sites/files/jps/js/js_gPqjYq7fqdMzw8-29XWQIVoDSWTmZCGy9OqaHppNxuQ.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create", "UA-4775024-1", {"cookieDomain":"auto"});ga("set", "anonymizeIp", true);ga("send", "pageview");
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"barthes","theme_token":"mUjWn0_sG8pep8k81nuZJtWvU-KL23Epjf4EdFoYZPo","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/google_analytics\/googleanalytics.js":1,"0":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"sites\/all\/modules\/date\/date_api\/date.css":1,"sites\/all\/modules\/date\/date_popup\/themes\/datepicker.1.7.css":1,"modules\/field\/theme\/field.css":1,"sites\/all\/modules\/mollom\/mollom.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/media\/modules\/media_wysiwyg\/css\/media_wysiwyg.base.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"public:\/\/geshi\/geshifilter-languages.css":1,"sites\/all\/modules\/geshifilter\/geshifilter.css":1,"themes\/bartik\/css\/layout.css":1,"themes\/bartik\/css\/style.css":1,"sites\/default\/themes\/custom\/barthes\/css\/colors.css":1,"sites\/default\/themes\/custom\/barthes\/css\/custom.css":1,"themes\/bartik\/css\/print.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie6.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc(x|m)?|dot(x|m)?|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt(x|m)?|pot(x|m)?|pps(x|m)?|ppam|sld(x|m)?|thmx|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls(x|m|b)?|xlt(x|m)|xlam|xml|z|zip"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in one-sidebar sidebar-second page-node page-node- page-node-593 node-type-blog" >
  <div id="skip-link">
    <a href="unicode-accented-characters-drupal-views-data-export-and-excel.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="page-wrapper"><div id="page">

  <div id="header" class="with-secondary-menu"><div class="section clearfix">

    
          <div id="name-and-slogan">

                              <div id="site-name">
              <strong>
                <a href="../../index.html" title="Home" rel="home"><span>J-P Stacey</span></a>
              </strong>
            </div>
                  
                  <div id="site-slogan">
            Drupal, programming culture, gardening, cycling and the environment          </div>
        
      </div> <!-- /#name-and-slogan -->
    
    
    
          <div id="secondary-menu" class="navigation">
        <h2 class="element-invisible">Secondary menu</h2><ul id="secondary-menu-links" class="links inline clearfix"><li class="menu-7322 first"><a href="../../cv.html" title="My curriculum vitae">CV</a></li>
<li class="menu-7320 last"><a href="../../contact.html" title="">Contact me</a></li>
</ul>      </div> <!-- /#secondary-menu -->
    
  </div></div> <!-- /.section, /#header -->

  
  
  <div id="main-wrapper" class="clearfix"><div id="main" class="clearfix">

    
    
    <div id="content" class="column"><div class="section">
            <a id="main-content"></a>
                    <h1 class="title" id="page-title">
          Unicode, accented characters, Drupal Views Data Export and Excel         </h1>
                          <div class="tabs">
                  </div>
                          <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div  class="ds-1col node node-blog node-promoted node-full view-mode-full clearfix">

  
  <div class="field field-name-post-date field-type-ds field-label-hidden"><div class="field-items"><div class="field-item even">Monday, May 4, 2015 - 16:00</div></div></div><div class="field field-name-field-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>If you need to assemble listings of content in Drupal, <a href="http://drupal.org/project/views">Views</a> is what you use. And if you need to export such a listing, into offline formats like CSV, <a href="http://drupal.org/project/views">Views Data Export</a> is a definite contender for how to do it. However, when you open the output in Microsoft Excel, you can end up—intentionally or otherwise—learning a great deal about the internals of Unicode encoding.</p>
<h3>Excel's handling of Unicode characters</h3>
<p>Excel has a problem. Well, Excel has many problems, but handling Unicode is one of them. It's <a href="http://stackoverflow.com/questions/6588068/which-encoding-opens-csv-files-correctly-with-excel-on-both-mac-and-windows">unable to reliably detect when a file is Unicode</a> rather than ASCII or one of the old Latin encodings.</p>
<p>I say "reliably", because I've had some exports that were fine (accented characters in Spanish names) and others that were broken (pound symbols in currency amounts.) The problem also only occurred on double-click opening rather than importing and thus selecting encoding options; but as exports sometimes need to be available to random members of the public, or transient staff or volunteers, user training was not an option.</p>
<p>We only had to deal with Excel for Windows, which simplified things slightly: but we did still need a fix.</p>
<h3>The encoding hint at the start of Unicode files</h3>
<p>As the table on the Stack Overflow issue above suggests, we can solve this problem by beginning our CSV files with a Byte Order Marker (BOM). This solves a specific problem, whereby Unicode characters can be represented by more than one byte on disk, and those bytes can be in either ascending or descending order. Arguments about which byte should come first are generally <a href="http://en.wikipedia.org/wiki/Endianness#Etymology">likened to those between characters from <cite>Gulliver's Travels</cite></a>. But Unicode as a standard remains strictly byte-order agnostic: it just states that, if you're using an order-sensitive format, you should definitely start the file with a BOM.</p>
<p>In theory, BOMs are therefore recommended in UTF-16 but certainly not required in UTF-8: its <a href="http://en.wikipedia.org/wiki/UTF-8#Description">special, "compressed" encoding</a> means that it rapidly becomes clear from the file which order the bytes are in, because only certain byte combinations are permitted. But adding <a href="http://en.wikipedia.org/wiki/Byte_order_mark#UTF-8">a BOM to UTF-8 files</a> at least hints at the fact that (a) the file is Unicode and (b) each character's byte sequence is ordered in one or other direction. This hint is at least useful for badly-behaved software; like, well, Excel!</p>
<h3>Overriding Views Data Export's theme templates</h3>
<p>Each VDE file format uses three files in the <span class="geshifilter"><code class="text geshifilter-text">theme/</code></span> subfolder of the module:</p>
<ul><li><span class="geshifilter"><code class="text geshifilter-text">views-data-export-[FORMAT]-header.tpl.php</code></span></li>
<li><span class="geshifilter"><code class="text geshifilter-text">views-data-export-[FORMAT]-body.tpl.php</code></span></li>
<li><span class="geshifilter"><code class="text geshifilter-text">views-data-export-[FORMAT]-footer.tpl.php</code></span></li>
</ul><p>Because we're only modifying the beginning of the file, we therefore want to copy <span class="geshifilter"><code class="text geshifilter-text">views-data-export-csv-header.tpl.php</code></span> to our site's custom theme, and add a single executable line (added below, with two comment lines) to write the BOM:</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span class="kw2">&lt;?php</span>
 
<span class="co1">// Print out header row, if option was selected.</span>
<span class="kw1">if</span> <span class="br0">(</span><span class="re0">$options</span><span class="br0">[</span><span class="st_h">'header'</span><span class="br0">]</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="co1">// Begin file with UTF-8 BOM.</span>
  <span class="kw1">print</span> <span class="st0">"<span class="es2">\xEF</span><span class="es2">\xBB</span><span class="es2">\xBF</span>"</span><span class="sy0">;</span>
  <span class="co1">// Now continue to output header as normal.</span>
  <span class="kw1">print</span> <a href="http://www.php.net/implode"><span class="kw3">implode</span></a><span class="br0">(</span><span class="re0">$separator</span><span class="sy0">,</span> <span class="re0">$header</span><span class="br0">)</span> <span class="sy0">.</span> <span class="st0">"<span class="es1">\r</span><span class="es1">\n</span>"</span><span class="sy0">;</span>
<span class="br0">}</span></pre></div>
<p>You will need to clear the theme-registry cache; you might also need to edit the view and, under "Advanced &gt; Theme information", rescan templates for theme files (I'm never completely certain of how Views' independent cache interacts with the theme registry.) And you could rename your file with the name of the view suffixed to it, if you really only wanted certain views to have the BOM fix.</p>
<p>But that's all you need to prefix a BOM to CSV files with Views Data Export, almost...</p>
<h3>The catch: if you're using an admin theme</h3>
<p>... that is: for anonymous users. However, some data exports are understandably restricted to only certain users, and we found that a particular admin-only export wasn't beginning with a BOM: our custom theme files weren't being used.</p>
<p>The clue was that the view's path(s) began <span class="geshifilter"><code class="text geshifilter-text">/admin/*</code></span>—in the site's administration backend—and this section of the site was using a different theme: an off-the-shelf admin theme, that we didn't really want to hack. Instead, I created a "shell" <a href="https://www.drupal.org/node/225125">sub-theme</a> of that admin theme, in order to put the templates in that.</p>
<p>As the sub-theme inherited everything in its parent, the only file I needed alongside my <span class="geshifilter"><code class="text geshifilter-text">csv-header</code></span> template was a <span class="geshifilter"><code class="text geshifilter-text">.info</code></span> file containing:</p>
<ul><li>Sub-theme <span class="geshifilter"><code class="text geshifilter-text">name</code></span>, <span class="geshifilter"><code class="text geshifilter-text">description</code></span> and <span class="geshifilter"><code class="text geshifilter-text">core=7.x</code></span> compatibility declaration.</li>
<li>Reference to the other theme as <span class="geshifilter"><code class="text geshifilter-text">base theme</code></span>.</li>
<li>Duplication of all the <span class="geshifilter"><code class="text geshifilter-text">region</code></span>s from the base theme.</li>
</ul><p>(I also added a <span class="geshifilter"><code class="text geshifilter-text">screenshot.png</code></span>, for completeness.) Then, with a copy of our custom <span class="geshifilter"><code class="text geshifilter-text">csv-header</code></span> template (as printed inline above) in this new admin theme; that admin theme selected on the "Appearance" page in Drupal; the fix finally worked for everyone: even admin users could download CSV with a BOM at the start, and Excel was finally happy.</p>
<h3>Summary</h3>
<p>It takes three bytes of output, and around a hundred extra characters of PHP in a file, to categorically fix Views Data Export for Excel. But the extra fiddliness in Drupal's theme layer, and the admin theme, means that you might need to duplicate that PHP file in a couple of places: you might even need to create a new theme to hold it in. But it's still a straightforward fix. If only the rest of Excel were so straightforwardly fixable!</p>
</div></div></div><div id="comments" class="comment-wrapper">
  
  
  </div>
</div>

  </div>
</div>
  </div>
      
    </div></div> <!-- /.section, /#content -->

          <div id="sidebar-second" class="column sidebar"><div class="section">
          <div class="region region-sidebar-second">
    <div id="block-block-7" class="block block-block">

    <h2>I&#039;m a Drupal Association member!</h2>
  
  <div class="content">
    <div style="margin: -15px 0"><a href="https://drupal.org/user/130486"><img src="https://association.drupal.org/files/Drupal_Association_ind_member_217_0.png" alt="My individual membership of the Drupal Association" title="You can view my DA membership on drupal.org" width="168" height="168" /></a></div>
  </div>
</div>
<div id="block-block-10" class="block block-block">

    <h2>Drupal 8 API tutorials</h2>
  
  <div class="content">
    <p>Want to learn about the Drupal 8 APIs, with worked examples? <a href="http://www.jpstacey.info/d8api">Follow my series of tutorials</a>, covering routing, caching, entities, config and much more!</p>
  </div>
</div>
<div id="block-stateblock-stateblock" class="block block-stateblock">

    <h2>Want to hire me?</h2>
  
  <div class="content">
    <a href="../../contact.html"><section class="state-no">
  <header>I'm currently</header>
  <section class="state-description">fully booked</section>
  <footer>for freelance work. But you can click here to contact me!</footer>
</section></a>  </div>
</div>
<div id="block-ds-extras-blogpost-secondary-nav" class="block block-ds-extras">

    
  <div class="content">
    <div class="field field-name-taxonomy-vocabulary-6 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Blog category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-category/hacking.html">hacking</a>, <a href="../../category/wordpress-category/layers.html">layers</a>, <a href="../../category/wordpress-category/quickies.html">quickies</a></li></ul></div><div class="field field-name-taxonomy-vocabulary-7 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Tags: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-tag/theme.html">theme</a>, <a href="../../category/wordpress-tag/template.html">template</a>, <a href="../../category/tags/unicode.html">unicode</a>, <a href="../../category/tags/planetdrupal.html">planetdrupal</a></li></ul></div>  </div>
</div>
<div id="block-views-recent-blog-block-1" class="block block-views">

    <h2>Recent blogposts</h2>
  
  <div class="content">
    <div class="view view-recent-blog view-id-recent_blog view-display-id-block_1 view-dom-id-82cd25dccf2f45c9f5742ed7159bd5b1">
        
  
  
      <div class="view-content">
        <ul>
    <li class="first odd">
      
      <h3>
  
    
      <a href="../2017-07-21/altering-length-drupal-8-text-field-contains-data.html">Altering the length of a Drupal 8 text field that contains data</a>
      </h3>
  

      <div>
  
    
      Friday, July 21, 2017 - 11:31
      </div>
  
    </li>
      <li class="even">
      
      <h3>
  
    
      <a href="../2017-06-02/menagerie-testing-behavioural-unit-system-smoke-regression-oh-my.html">A menagerie of testing: behavioural, unit, system, smoke, regression, oh my!</a>
      </h3>
  

      <div>
  
    
      Friday, June 2, 2017 - 10:11
      </div>
  
    </li>
      <li class="last odd">
      
      <h3>
  
    
      <a href="../2017-05-30/including-javascript-behat-tests-all-inside-headless-virtual-machine.html">Including Javascript in Behat tests, all inside a headless, virtual machine</a>
      </h3>
  

      <div>
  
    
      Tuesday, May 30, 2017 - 16:51
      </div>
  
    </li>
    </ul>
    </div>
  
  
  
      
<div class="more-link">
  <a href="../../blog_view.html">
    All blogposts  </a>
</div>
  
  
  
</div>  </div>
</div>
<div id="block-block-5" class="block block-block">

    <h2>About me</h2>
  
  <div class="content">
    <p>I'm J-P Stacey, and I'm a freelance technical developer and software architect, working with <a href="http://drupal.org/">Drupal</a>, Javascript, Symfony, PHP and devops, with experience in project and process management and an emphasis on usability.</p>
<p>I live in the <a href="http://gov.uk">UK</a>; my website is self-hosted on <a href="http://bigv.io">bigv.io</a>; my email is hosted by <a href="http://mail.google.com">Google</a>, and that's also what I use to share files. <small>(<a href="https://data-jurisdiction.org/country/GB">More info</a>|<a href="http://www.jpstacey.info/blog/2013-08-20/what-jurisdiction-am-i-in">What is this?</a>)</small></p>
  </div>
</div>
<div id="block-menu-secondary-menu" class="block block-menu">

    <h2>Find me elsewhere</h2>
  
  <div class="content">
    <ul class="menu clearfix"><li class="first leaf"><a href="http://twitter.com/mphield" title="My commercial account on Twitter">Company @ Twitter</a></li>
<li class="leaf"><a href="http://drupal.org/user/130486" title="Drupal user #130486: woohoo!">Drupal @ d.o</a></li>
<li class="leaf"><a href="http://github.com/jpstacey" title="My code repositories on Github">Code @ Github</a></li>
<li class="leaf"><a href="http://flickr.com/photos/eustatius" title="My photos on Flickr">Photos @ Flickr</a></li>
<li class="last leaf"><a href="http://pinboard.in/u:jpstacey" title="My links on the Pinboard bookmarking site">Links @ Pinboard</a></li>
</ul>  </div>
</div>
  </div>
      </div></div> <!-- /.section, /#sidebar-second -->
    
  </div></div> <!-- /#main, /#main-wrapper -->

  
  <div id="footer-wrapper"><div class="section">

    
    
  </div></div> <!-- /.section, /#footer-wrapper -->

</div></div> <!-- /#page, /#page-wrapper -->
  </body>
</html>
