<!DOCTYPE html>
<html lang="en" version="XHTML+RDFa 1.0" dir="ltr">
<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../sites/files/jps/starberry_favicon.png" type="image/png" />
<meta name="generator" content="Drupal 7 (https://www.drupal.org)" />
<link rel="canonical" href="../blog/2013-11-03/migrating-data-drupal-over-port-forwarding.html" />
<link rel="shortlink" href="490.html" />
  <title>Migrating data into Drupal over port forwarding | J-P Stacey</title>
  <link type="text/css" rel="stylesheet" href="../sites/files/jps/css/css_xE-rWrJf-fncB6ztZfd2huxqgxu4WO-qwma6Xer30m4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../sites/files/jps/css/css_jdej_Zz2sjg--A2C2aVJ-Qt5W-fI_fkFnsddutilsws.css" media="all" />
<link type="text/css" rel="stylesheet" href="../sites/files/jps/css/css_A3Qn9PgslsjDpW1HfgFuI26cQlhJ23E7y9wyYqpiJIA.css" media="all" />
<link type="text/css" rel="stylesheet" href="../sites/files/jps/css/css_0Heb-O6YY5Tn5xG4WrHtAAXZCtYk-eKiVo7PlP1bsg4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../sites/files/jps/css/css_2THG1eGiBIizsWFeexsNe1iDifJ00QRS9uSd03rY9co.css" media="print" />

<!--[if lte IE 7]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie.css?qfgo2z" media="all" />
<![endif]-->

<!--[if IE 6]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie6.css?qfgo2z" media="all" />
<![endif]-->
  <script type="text/javascript" src="../sites/files/jps/js/js_vDrW3Ry_4gtSYaLsh77lWhWjIC6ml2QNkcfvfP5CVFs.js"></script>
<script type="text/javascript" src="../sites/files/jps/js/js_gPqjYq7fqdMzw8-29XWQIVoDSWTmZCGy9OqaHppNxuQ.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create", "UA-4775024-1", {"cookieDomain":"auto"});ga("set", "anonymizeIp", true);ga("send", "pageview");
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"barthes","theme_token":"JE2NOF4xtrDpQ3sIn0aZwOIP5JWQD9pCMRxZVE7Rv5Q","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/google_analytics\/googleanalytics.js":1,"0":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"sites\/all\/modules\/date\/date_api\/date.css":1,"sites\/all\/modules\/date\/date_popup\/themes\/datepicker.1.7.css":1,"modules\/field\/theme\/field.css":1,"sites\/all\/modules\/mollom\/mollom.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/media\/modules\/media_wysiwyg\/css\/media_wysiwyg.base.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"public:\/\/geshi\/geshifilter-languages.css":1,"sites\/all\/modules\/geshifilter\/geshifilter.css":1,"themes\/bartik\/css\/layout.css":1,"themes\/bartik\/css\/style.css":1,"sites\/default\/themes\/custom\/barthes\/css\/colors.css":1,"sites\/default\/themes\/custom\/barthes\/css\/custom.css":1,"themes\/bartik\/css\/print.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie6.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc(x|m)?|dot(x|m)?|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt(x|m)?|pot(x|m)?|pps(x|m)?|ppam|sld(x|m)?|thmx|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls(x|m|b)?|xlt(x|m)|xlam|xml|z|zip"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in one-sidebar sidebar-second page-node page-node- page-node-490 node-type-blog" >
  <div id="skip-link">
    <a href="490.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="page-wrapper"><div id="page">

  <div id="header" class="with-secondary-menu"><div class="section clearfix">

    
          <div id="name-and-slogan">

                              <div id="site-name">
              <strong>
                <a href="../index.html" title="Home" rel="home"><span>J-P Stacey</span></a>
              </strong>
            </div>
                  
                  <div id="site-slogan">
            Drupal, programming culture, gardening, cycling and the environment          </div>
        
      </div> <!-- /#name-and-slogan -->
    
    
    
          <div id="secondary-menu" class="navigation">
        <h2 class="element-invisible">Secondary menu</h2><ul id="secondary-menu-links" class="links inline clearfix"><li class="menu-7322 first"><a href="../cv.html" title="My curriculum vitae">CV</a></li>
<li class="menu-7320 last"><a href="../contact.html" title="">Contact me</a></li>
</ul>      </div> <!-- /#secondary-menu -->
    
  </div></div> <!-- /.section, /#header -->

  
  
  <div id="main-wrapper" class="clearfix"><div id="main" class="clearfix">

    
    
    <div id="content" class="column"><div class="section">
            <a id="main-content"></a>
                    <h1 class="title" id="page-title">
          Migrating data into Drupal over port forwarding        </h1>
                          <div class="tabs">
                  </div>
                          <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div  class="ds-1col node node-blog node-promoted node-full view-mode-full clearfix">

  
  <div class="field field-name-post-date field-type-ds field-label-hidden"><div class="field-items"><div class="field-item even">Sunday, November 3, 2013 - 19:58</div></div></div><div class="field field-name-field-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>Migrate is a framework for getting data into a Drupal website from all sorts of remote data sources. When those sources are MySQL databases, they can be represented in your site's <span class="geshifilter"><code class="text geshifilter-text">settings.php</code></span>.</p>
<p>However, sometimes you'll need to test your migrations outside of the trusted server(s) that can connect to your data sources. For example, say you're importing from a corporate blog outside of Drupal, into your live Drupal site. You won't want just any old server to be able to view data in the corporate blog, so your sysadmins will have already locked down access, typically with firewalls first of all (and much more.) Your local development environment probably won't be able to get through that firewall on the MySQL port. And what if you're developing from home? Worst of all, when Migrate checks all of its data sources and finds one it can't connect to, it breaks hard: a <span class="geshifilter"><code class="text geshifilter-text">watchdog()</code></span> message, a PHP exception and a HTTP 500 error. </p>
<p>If you can't reconfigure the firewall (for whatever reason: ours was that the third-party host administrator was on holiday for a few days!) then here's a three-part hack to get around gradually more complicated access restrictions.</p>
<h2>1. SSH port forwarding</h2>
<p>You need to be able to SSH to a server that your data source's firewall "trusts" - typically the production server, but it could be any server that has access through the firewall. Do so, and when you do it, add the following <span class="geshifilter"><code class="text geshifilter-text">-L</code></span> argument.</p>
<div class="geshifilter">
<pre class="bash geshifilter-bash" style="font-family:monospace;"><span class="kw2">ssh</span> account<span class="sy0">@</span>trusted.example.com -L9991:firewalled1.example.com:<span class="nu0">3306</span></pre></div>
<p>This forwards traffic on your local :9991 port to the MySQL port on firewalled1.example.com, <em>as seen from the trusted server</em>.</p>
<p>Repeat this for every remote server: firewalled2, firewalled3 etc. Increment the "9991" every time, so each server has a different port assigned to it. Use high-numbered ports as that keeps your port forwarding out of the way of other services that might already be running on your own local machine.</p>
<p><em>(There are tricks to forward multiple ports over a single SSH connection, but this is the most straightforward way to do it.)</em></p>
<h2>2. Drupal data sources</h2>
<p>Now you need to change your Drupal data sources. We keep <span class="geshifilter"><code class="text geshifilter-text">settings.php</code></span> in version control - making it harder to lose any special configuration like cacheing or Domain Access, if you have a serious outage - so we try not to modify the file directly.</p>
<p>At the end of <span class="geshifilter"><code class="text geshifilter-text">settings.php</code></span>, add the following <span class="geshifilter"><code class="text geshifilter-text">include()</code></span> directive:</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span class="kw2">&lt;?php</span>
<span class="coMULTI">/* ... end of settings.php */</span>
<span class="kw1">include</span><span class="br0">(</span><span class="st_h">'settings-local.php'</span><span class="br0">)</span><span class="sy0">;</span></pre></div>
<p>Then, in <span class="geshifilter"><code class="text geshifilter-text">settings-local.php</code></span>, put the following code:</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span class="kw2">&lt;?php</span>
<span class="re0">$port_forwards</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span>
  <span class="st_h">'firewalled1.example.com'</span> <span class="sy0">=&gt;</span> <span class="st_h">'9991'</span><span class="sy0">,</span>
  <span class="st_h">'firewalled2.example.com'</span> <span class="sy0">=&gt;</span> <span class="st_h">'9992'</span><span class="sy0">,</span>
  <span class="st_h">'firewalled3.example.com'</span> <span class="sy0">=&gt;</span> <span class="st_h">'9993'</span><span class="sy0">,</span>
<span class="br0">)</span><span class="sy0">;</span>
 
<span class="kw1">foreach</span><span class="br0">(</span><span class="re0">$databases</span> <span class="kw1">as</span> <span class="re0">$name</span> <span class="sy0">=&gt;</span> <span class="sy0">&amp;</span><span class="re0">$db</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="co1">// Is this a port-forwarded host</span>
  <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span><a href="http://www.php.net/isset"><span class="kw3">isset</span></a><span class="br0">(</span><span class="re0">$port_forwards</span><span class="br0">[</span><span class="re0">$db</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'host'</span><span class="br0">]</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
    <span class="kw1">continue</span><span class="sy0">;</span>
  <span class="br0">}</span>
 
  <span class="co1">// Substitute in the host and port, keeping a record of</span>
  <span class="co1">// the old host for debugging purposes</span>
  <span class="re0">$db</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'port'</span><span class="br0">]</span> <span class="sy0">=</span> <span class="re0">$port_forwards</span><span class="br0">[</span><span class="re0">$db</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'host'</span><span class="br0">]</span><span class="br0">]</span><span class="sy0">;</span>
  <span class="re0">$db</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'_old_host'</span><span class="br0">]</span> <span class="sy0">=</span> <span class="re0">$db</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'host'</span><span class="br0">]</span><span class="sy0">;</span>
  <span class="re0">$db</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'host'</span><span class="br0">]</span> <span class="sy0">=</span> <span class="st_h">'localhost'</span><span class="sy0">;</span> <span class="co1">// We'll change this in a bit!</span>
<span class="br0">}</span></pre></div>
<p>Typically you'll have your local default-default Drupal database, followed by multiple remote Migrate data sources. So we distinguish between them by seeing whether or not the host is one of our firewalled hosts.</p>
<p>You'll see that we've set the new connection host to be <span class="geshifilter"><code class="text geshifilter-text">localhost</code></span>. This might not work as we'll see.</p>
<h2>3. Tricking mysql-client with /etc/hosts</h2>
<p>If you've been given a MySQL user for your migration, it will probably have come with a password, and it'll be represented as a Drupal data source something like this:</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span class="kw2">&lt;?php</span>
<span class="co1">// Primary connection</span>
<span class="re0">$databases</span><span class="br0">[</span><span class="st_h">'migrate_data_source'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'default'</span><span class="br0">]</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a> <span class="br0">(</span>
  <span class="st_h">'database'</span> <span class="sy0">=&gt;</span> <span class="st_h">'remote_db'</span><span class="sy0">,</span>
  <span class="st_h">'username'</span> <span class="sy0">=&gt;</span> <span class="st_h">'drupal'</span><span class="sy0">,</span>
  <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'jozxyqk'</span><span class="sy0">,</span>
  <span class="st_h">'host'</span> <span class="sy0">=&gt;</span> <span class="st_h">'firewalled1.example.com'</span><span class="sy0">,</span>
  <span class="st_h">'driver'</span> <span class="sy0">=&gt;</span> <span class="st_h">'mysql'</span><span class="sy0">,</span>
<span class="br0">)</span><span class="sy0">;</span></pre></div>
<p>However, the <span class="geshifilter"><code class="text geshifilter-text">drupal</code></span> user in our example has almost certainly only been given permission in MySQL to access from trusted hosts and nowhere else: maybe that's the live server, which firewalled1 sees as being called "trusted.internal.example.com". That means the SQL used to grant permissions was something like:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">GRANT ALL ON remote_db.* TO 'drupal'@'trusted.internal.example.com' IDENTIFIED BY 'jozxyqk';</pre></div>
<p>This is good "defence in depth", but it will also lead to the following error, even after you've got your port forwarding set up:</p>
<div class="geshifilter">
<pre class="bash geshifilter-bash" style="font-family:monospace;">mysql <span class="re5">-u</span> drupal <span class="re5">-h</span> localhost <span class="re5">-P</span> 9993 remote_db <span class="re5">-p</span>
Enter password: 
ERROR 1045 <span class="br0">(</span>28000<span class="br0">)</span>: Access denied <span class="kw1">for</span> user <span class="st_h">'drupal'</span><span class="sy0">@</span><span class="st_h">'localhost'</span> <span class="br0">(</span>using password: YES<span class="br0">)</span></pre></div>
<p>How to trick mysql-client into thinking you're coming from trusted.internal.example.com? Add this line to /etc/hosts:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family:monospace;">127.0.0.1 trusted.internal.example.com</pre></div>
<p>and connect using host=trusted.internal.example.com , not host=localhost:</p>
<div class="geshifilter">
<pre class="bash geshifilter-bash" style="font-family:monospace;">mysql <span class="re5">-u</span> migration <span class="re5">-h</span> trusted.internal.example.com <span class="re5">-P</span> 9993 aadblog <span class="re5">-p</span>
Enter password: 
Reading table information <span class="kw1">for</span> completion of table and column names
...</pre></div>
<p>Update the code snippet defined above in 2, to use the new host, and you should be away. Once you're able to navigate to the Migrate admin screen, that means Drupal has successfully accessed all MySQL data sources.</p>
<h2>That was a bit of a roundabout way of setting up a migration, wasn't it?</h2>
<p>Absolutely. If at all possible, you should get a sysadmin to reconfigure the server instead. But sometimes, for whatever reason, that just isn't possible. In those cases, it's good to know that there exists a workaround - however tortuous.</p>
</div></div></div></div>

  </div>
</div>
  </div>
      
    </div></div> <!-- /.section, /#content -->

          <div id="sidebar-second" class="column sidebar"><div class="section">
          <div class="region region-sidebar-second">
    <div id="block-block-7" class="block block-block">

    <h2>I&#039;m a Drupal Association member!</h2>
  
  <div class="content">
    <div style="margin: -15px 0"><a href="https://drupal.org/user/130486"><img src="https://association.drupal.org/files/Drupal_Association_ind_member_217_0.png" alt="My individual membership of the Drupal Association" title="You can view my DA membership on drupal.org" width="168" height="168" /></a></div>
  </div>
</div>
<div id="block-block-10" class="block block-block">

    <h2>Drupal 8 API tutorials</h2>
  
  <div class="content">
    <p>Want to learn about the Drupal 8 APIs, with worked examples? <a href="/d8api.html">Follow my series of tutorials</a>, covering routing, caching, entities, config and much more!</p>
  </div>
</div>
<div id="block-stateblock-stateblock" class="block block-stateblock">

    <h2>Want to hire me?</h2>
  
  <div class="content">
    <a href="../contact.html"><section class="state-no">
  <header>I'm currently</header>
  <section class="state-description">fully booked</section>
  <footer>for freelance work. But you can click here to contact me!</footer>
</section></a>  </div>
</div>
<div id="block-ds-extras-blogpost-secondary-nav" class="block block-ds-extras">

    
  <div class="content">
    <div class="field field-name-taxonomy-vocabulary-6 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Blog category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../category/wordpress-category/diagnostics.html">diagnostics</a>, <a href="../category/wordpress-category/hacking.html">hacking</a>, <a href="../category/wordpress-category/layers.html">layers</a></li></ul></div><div class="field field-name-taxonomy-vocabulary-7 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Tags: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../category/wordpress-tag/ssh.html">ssh</a>, <a href="../category/tags/firewall.html">firewall</a>, <a href="../category/tags/migrate.html">migrate</a></li></ul></div>  </div>
</div>
<div id="block-views-recent-blog-block-1" class="block block-views">

    <h2>Recent blogposts</h2>
  
  <div class="content">
    <div class="view view-recent-blog view-id-recent_blog view-display-id-block_1 view-dom-id-842c035fe648994cebbc54f019348d65">
        
  
  
      <div class="view-content">
        <ul>
    <li class="first odd">
      
      <h3>
  
    
      <a href="../blog/2017-07-21/altering-length-drupal-8-text-field-contains-data.html">Altering the length of a Drupal 8 text field that contains data</a>
      </h3>
  

      <div>
  
    
      Friday, July 21, 2017 - 11:31
      </div>
  
    </li>
      <li class="even">
      
      <h3>
  
    
      <a href="../blog/2017-06-02/menagerie-testing-behavioural-unit-system-smoke-regression-oh-my.html">A menagerie of testing: behavioural, unit, system, smoke, regression, oh my!</a>
      </h3>
  

      <div>
  
    
      Friday, June 2, 2017 - 10:11
      </div>
  
    </li>
      <li class="last odd">
      
      <h3>
  
    
      <a href="../blog/2017-05-30/including-javascript-behat-tests-all-inside-headless-virtual-machine.html">Including Javascript in Behat tests, all inside a headless, virtual machine</a>
      </h3>
  

      <div>
  
    
      Tuesday, May 30, 2017 - 16:51
      </div>
  
    </li>
    </ul>
    </div>
  
  
  
      
<div class="more-link">
  <a href="../blog_view.html">
    All blogposts  </a>
</div>
  
  
  
</div>  </div>
</div>
<div id="block-block-5" class="block block-block">

    <h2>About me</h2>
  
  <div class="content">
    <p>I'm J-P Stacey, and I'm a freelance technical developer and software architect, working with <a href="http://drupal.org/">Drupal</a>, Javascript, Symfony, PHP and devops, with experience in project and process management and an emphasis on usability.</p>
<p>I live in the <a href="http://gov.uk">UK</a>; my website is self-hosted on <a href="http://bigv.io">bigv.io</a>; my email is hosted by <a href="http://mail.google.com">Google</a>, and that's also what I use to share files. <small>(<a href="https://data-jurisdiction.org/country/GB">More info</a>|<a href="/blog/2013-08-20/what-jurisdiction-am-i-in.html">What is this?</a>)</small></p>
  </div>
</div>
<div id="block-menu-secondary-menu" class="block block-menu">

    <h2>Find me elsewhere</h2>
  
  <div class="content">
    <ul class="menu clearfix"><li class="first leaf"><a href="http://twitter.com/mphield" title="My commercial account on Twitter">Company @ Twitter</a></li>
<li class="leaf"><a href="http://drupal.org/user/130486" title="Drupal user #130486: woohoo!">Drupal @ d.o</a></li>
<li class="leaf"><a href="http://github.com/jpstacey" title="My code repositories on Github">Code @ Github</a></li>
<li class="leaf"><a href="http://flickr.com/photos/eustatius" title="My photos on Flickr">Photos @ Flickr</a></li>
<li class="last leaf"><a href="http://pinboard.in/u:jpstacey" title="My links on the Pinboard bookmarking site">Links @ Pinboard</a></li>
</ul>  </div>
</div>
  </div>
      </div></div> <!-- /.section, /#sidebar-second -->
    
  </div></div> <!-- /#main, /#main-wrapper -->

  
  <div id="footer-wrapper"><div class="section">

    
    
  </div></div> <!-- /.section, /#footer-wrapper -->

</div></div> <!-- /#page, /#page-wrapper -->
  </body>
</html>
