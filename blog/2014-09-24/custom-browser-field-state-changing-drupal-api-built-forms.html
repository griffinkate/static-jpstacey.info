<!DOCTYPE html>
<html lang="en" version="XHTML+RDFa 1.0" dir="ltr">
<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="../../sites/files/jps/starberry_favicon.png" type="image/png" />
<meta name="generator" content="Drupal 7 (https://www.drupal.org)" />
<link rel="canonical" href="custom-browser-field-state-changing-drupal-api-built-forms.html" />
<link rel="shortlink" href="../../node/553.html" />
  <title>Custom in-browser field state changing on Drupal API-built forms | J-P Stacey</title>
  <link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_xE-rWrJf-fncB6ztZfd2huxqgxu4WO-qwma6Xer30m4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_jdej_Zz2sjg--A2C2aVJ-Qt5W-fI_fkFnsddutilsws.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_A3Qn9PgslsjDpW1HfgFuI26cQlhJ23E7y9wyYqpiJIA.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_0Heb-O6YY5Tn5xG4WrHtAAXZCtYk-eKiVo7PlP1bsg4.css" media="all" />
<link type="text/css" rel="stylesheet" href="../../sites/files/jps/css/css_2THG1eGiBIizsWFeexsNe1iDifJ00QRS9uSd03rY9co.css" media="print" />

<!--[if lte IE 7]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie.css?qfgo2z" media="all" />
<![endif]-->

<!--[if IE 6]>
<link type="text/css" rel="stylesheet" href="http://jpstacey.lndo.site/sites/default/themes/custom/barthes/css/ie6.css?qfgo2z" media="all" />
<![endif]-->
  <script type="text/javascript" src="../../sites/files/jps/js/js_vDrW3Ry_4gtSYaLsh77lWhWjIC6ml2QNkcfvfP5CVFs.js"></script>
<script type="text/javascript" src="../../sites/files/jps/js/js_gPqjYq7fqdMzw8-29XWQIVoDSWTmZCGy9OqaHppNxuQ.js"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create", "UA-4775024-1", {"cookieDomain":"auto"});ga("set", "anonymizeIp", true);ga("send", "pageview");
//--><!]]>
</script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/","pathPrefix":"","ajaxPageState":{"theme":"barthes","theme_token":"iLVCCmZGiXSANbXCmToA2LysBJCRPqgjWW2JehMK7cg","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1,"sites\/all\/modules\/google_analytics\/googleanalytics.js":1,"0":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/comment\/comment.css":1,"sites\/all\/modules\/date\/date_api\/date.css":1,"sites\/all\/modules\/date\/date_popup\/themes\/datepicker.1.7.css":1,"modules\/field\/theme\/field.css":1,"sites\/all\/modules\/mollom\/mollom.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/views\/css\/views.css":1,"sites\/all\/modules\/media\/modules\/media_wysiwyg\/css\/media_wysiwyg.base.css":1,"sites\/all\/modules\/ctools\/css\/ctools.css":1,"public:\/\/geshi\/geshifilter-languages.css":1,"sites\/all\/modules\/geshifilter\/geshifilter.css":1,"themes\/bartik\/css\/layout.css":1,"themes\/bartik\/css\/style.css":1,"sites\/default\/themes\/custom\/barthes\/css\/colors.css":1,"sites\/default\/themes\/custom\/barthes\/css\/custom.css":1,"themes\/bartik\/css\/print.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie.css":1,"sites\/default\/themes\/custom\/barthes\/css\/ie6.css":1}},"googleanalytics":{"trackOutbound":1,"trackMailto":1,"trackDownload":1,"trackDownloadExtensions":"7z|aac|arc|arj|asf|asx|avi|bin|csv|doc(x|m)?|dot(x|m)?|exe|flv|gif|gz|gzip|hqx|jar|jpe?g|js|mp(2|3|4|e?g)|mov(ie)?|msi|msp|pdf|phps|png|ppt(x|m)?|pot(x|m)?|pps(x|m)?|ppam|sld(x|m)?|thmx|qtm?|ra(m|r)?|sea|sit|tar|tgz|torrent|txt|wav|wma|wmv|wpd|xls(x|m|b)?|xlt(x|m)|xlam|xml|z|zip"}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in one-sidebar sidebar-second page-node page-node- page-node-553 node-type-blog" >
  <div id="skip-link">
    <a href="custom-browser-field-state-changing-drupal-api-built-forms.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div id="page-wrapper"><div id="page">

  <div id="header" class="with-secondary-menu"><div class="section clearfix">

    
          <div id="name-and-slogan">

                              <div id="site-name">
              <strong>
                <a href="../../index.html" title="Home" rel="home"><span>J-P Stacey</span></a>
              </strong>
            </div>
                  
                  <div id="site-slogan">
            Drupal, programming culture, gardening, cycling and the environment          </div>
        
      </div> <!-- /#name-and-slogan -->
    
    
    
          <div id="secondary-menu" class="navigation">
        <h2 class="element-invisible">Secondary menu</h2><ul id="secondary-menu-links" class="links inline clearfix"><li class="menu-7322 first"><a href="../../cv.html" title="My curriculum vitae">CV</a></li>
<li class="menu-7320 last"><a href="../../contact.html" title="">Contact me</a></li>
</ul>      </div> <!-- /#secondary-menu -->
    
  </div></div> <!-- /.section, /#header -->

  
  
  <div id="main-wrapper" class="clearfix"><div id="main" class="clearfix">

    
    
    <div id="content" class="column"><div class="section">
            <a id="main-content"></a>
                    <h1 class="title" id="page-title">
          Custom in-browser field state changing on Drupal API-built forms        </h1>
                          <div class="tabs">
                  </div>
                          <div class="region region-content">
    <div id="block-system-main" class="block block-system">

    
  <div class="content">
    <div  class="ds-1col node node-blog node-promoted node-full view-mode-full clearfix">

  
  <div class="field field-name-post-date field-type-ds field-label-hidden"><div class="field-items"><div class="field-item even">Wednesday, September 24, 2014 - 20:26</div></div></div><div class="field field-name-field-body field-type-text-long field-label-hidden"><div class="field-items"><div class="field-item even"><p>Let's say you've built, or are building, a form in Drupal 7, using <a href="https://api.drupal.org/api/drupal/developer%21topics%21forms_api_reference.html/7">Form API</a>. You want certain fields to change, depending on certain other fields: for example, if someone clicks a checkbox, you want other fields to disable because they're irrelevant. This must all happen in the browser.</p>
<h2>Core D7: form states to modify a form in the browser</h2>
<p>This is what <a href="https://api.drupal.org/api/examples/form_example%21form_example_states.inc/function/form_example_states_form/7">form states</a> were intended for: they allow you to use Form API array attributes to:</p>
<ol><li>listen to another element (using jQuery selectors)</li>
<li>wait for the element to match certain conditions (e.g. checked/unchecked)</li>
<li>if the conditions are met, perform an action the element whose Form API array you've added to</li>
</ol><p>This works a treat, but unfortunately the number of different condition types (2) and action types (3) <a href="https://api.drupal.org/api/drupal/includes%21common.inc/function/drupal_process_states/7">available in core is limited</a>. But the great news is you can extend them if you need to.</p>
<h2>Extending core form states with a custom action</h2>
<p>We were building an install profile intended to build a site with "one click": or at any rate, trying to reduce the number of clicks etc. as much as possible. One thing we wanted, post-install, was to be able to create a UID=2 user very quickly. This is important, as UID=1 bypasses the permissions system, and if everyone has to keep using UID=1 then there's no paper trail: we wanted instead to have a team of admins on the site, all under their real names, all with configurable permissions.</p>
<p>However, while we were developing, and repeatedly reinstalling, we didn't want to have to keep entering in the details for UID=2. Could we have it so that, if a checkbox for "dev mode" is checked, then the form for UID=2 is automatically pre-populated?</p>
<p>It turns out that it's easy to extend form states to have this new "devmode" action, using the following Javascript:</p>
<div class="geshifilter">
<pre class="javascript geshifilter-javascript" style="font-family:monospace;"><span class="coMULTI">/**
 * Support post-install task forms.
 */</span>
<span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span>$<span class="br0">)</span> <span class="br0">{</span>
 
<span class="co1">// Username, email suffix, password etc. in dev mode.</span>
<span class="kw2">var</span> username <span class="sy0">=</span> <span class="st0">"site.admin"</span><span class="sy0">;</span>
 
<span class="coMULTI">/**
 * Register custom state change: devmode.
 */</span>
$<span class="br0">(</span>document<span class="br0">)</span>.<span class="me1">bind</span><span class="br0">(</span><span class="st0">'state:devmode'</span><span class="sy0">,</span> <span class="kw2">function</span><span class="br0">(</span>e<span class="br0">)</span> <span class="br0">{</span>
  <span class="kw1">if</span> <span class="br0">(</span>e.<span class="me1">trigger</span><span class="br0">)</span> <span class="br0">{</span>
    <span class="co1">// If we're in dev mode, populate fields.</span>
    <span class="kw1">if</span> <span class="br0">(</span>e.<span class="me1">value</span><span class="br0">)</span> <span class="br0">{</span>
      $<span class="br0">(</span><span class="st0">'#edit-username'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span>username<span class="br0">)</span><span class="sy0">;</span>
      $<span class="br0">(</span><span class="st0">'#edit-email'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span>username <span class="sy0">+</span> <span class="st0">"@example.com"</span><span class="br0">)</span><span class="sy0">;</span>
      $<span class="br0">(</span><span class="st0">'#edit-password-pass1'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span>username<span class="br0">)</span><span class="sy0">;</span>
      $<span class="br0">(</span><span class="st0">'#edit-password-pass2'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span>username<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
    <span class="co1">// If we're not in dev mode, ensure fields are empty.</span>
    <span class="kw1">else</span> <span class="br0">{</span>
      $<span class="br0">(</span><span class="st0">'#edit-username'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span><span class="st0">""</span><span class="br0">)</span><span class="sy0">;</span>
      $<span class="br0">(</span><span class="st0">'#edit-email'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span><span class="st0">""</span><span class="br0">)</span><span class="sy0">;</span>
      $<span class="br0">(</span><span class="st0">'#edit-password-pass1'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span><span class="st0">""</span><span class="br0">)</span><span class="sy0">;</span>
      $<span class="br0">(</span><span class="st0">'#edit-password-pass2'</span><span class="br0">)</span>.<span class="me1">val</span><span class="br0">(</span><span class="st0">""</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
  <span class="br0">}</span>
<span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
 
<span class="br0">}</span><span class="br0">)</span><span class="br0">(</span>jQuery<span class="br0">)</span><span class="sy0">;</span></pre></div>
<p>Put this in the same module you're building your form with. Now to use the extension!</p>
<h2>Using our extension to the form state actions</h2>
<p>To use this extension action on a particular form, you need to do two things:</p>
<ol><li>Attach the new Javascript file to the form using an <span class="geshifilter"><code class="text geshifilter-text">#attach</code></span> parameter.</li>
<li>Register a form state change, which uses the action.</li>
</ol><p>Here's how you might do this in a form API callback:</p>
<div class="geshifilter">
<pre class="php geshifilter-php" style="font-family:monospace;"><span class="kw2">&lt;?php</span>
<span class="co4">/**
 * Form API callback: implements state:devmode.
 */</span>
<span class="kw2">function</span> mymodule_myform<span class="br0">(</span><span class="re0">$form</span><span class="sy0">,</span> <span class="sy0">&amp;</span><span class="re0">$form_state</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="coMULTI">/* ... */</span>
 
  <span class="co1">// We only add the state change to one field; JS references the others.</span>
  <span class="re0">$form</span><span class="br0">[</span><span class="st_h">'users'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'new_user'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'username'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'#states'</span><span class="br0">]</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span>
    <span class="co1">// Set a watch for our checkbox's element ID: edit-production-mode.</span>
    <span class="st_h">'devmode'</span> <span class="sy0">=&gt;</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'#edit-production-mode'</span> <span class="sy0">=&gt;</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">(</span><span class="st_h">'unchecked'</span> <span class="sy0">=&gt;</span> <span class="kw4">TRUE</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">,</span>
  <span class="br0">)</span><span class="sy0">;</span>
 
  <span class="co1">// And attach Javascript we wrote earlier, to support our new action.</span>
  <span class="re0">$form</span><span class="br0">[</span><span class="st_h">'#attached'</span><span class="br0">]</span><span class="br0">[</span><span class="st_h">'js'</span><span class="br0">]</span><span class="br0">[</span><span class="br0">]</span> <span class="sy0">=</span> drupal_get_path<span class="br0">(</span><span class="st_h">'module'</span><span class="sy0">,</span> <span class="st_h">'mymodule'</span><span class="br0">)</span>
    <span class="sy0">.</span> <span class="st_h">'/js/devmode.js'</span><span class="sy0">;</span>
 
  <span class="coMULTI">/* ... */</span>
  <span class="kw1">return</span> <span class="re0">$form</span><span class="sy0">;</span>
<span class="br0">}</span></pre></div>
<p>And that's it. Custom form state action, implemented in around two dozen lines of code (many of them comments). Obviously anything serious you would do with form states, you'd also want to check for on the server: data integrity, etc. But for improving the user experience in small increments, form states take a lot of beating.</p>
</div></div></div><div id="comments" class="comment-wrapper">
  
  
  </div>
</div>

  </div>
</div>
  </div>
      
    </div></div> <!-- /.section, /#content -->

          <div id="sidebar-second" class="column sidebar"><div class="section">
          <div class="region region-sidebar-second">
    <div id="block-block-7" class="block block-block">

    <h2>I&#039;m a Drupal Association member!</h2>
  
  <div class="content">
    <div style="margin: -15px 0"><a href="https://drupal.org/user/130486"><img src="https://association.drupal.org/files/Drupal_Association_ind_member_217_0.png" alt="My individual membership of the Drupal Association" title="You can view my DA membership on drupal.org" width="168" height="168" /></a></div>
  </div>
</div>
<div id="block-block-10" class="block block-block">

    <h2>Drupal 8 API tutorials</h2>
  
  <div class="content">
    <p>Want to learn about the Drupal 8 APIs, with worked examples? <a href="http://www.jpstacey.info/d8api">Follow my series of tutorials</a>, covering routing, caching, entities, config and much more!</p>
  </div>
</div>
<div id="block-stateblock-stateblock" class="block block-stateblock">

    <h2>Want to hire me?</h2>
  
  <div class="content">
    <a href="../../contact.html"><section class="state-no">
  <header>I'm currently</header>
  <section class="state-description">fully booked</section>
  <footer>for freelance work. But you can click here to contact me!</footer>
</section></a>  </div>
</div>
<div id="block-ds-extras-blogpost-secondary-nav" class="block block-ds-extras">

    
  <div class="content">
    <div class="field field-name-taxonomy-vocabulary-6 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Blog category: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-category/framework.html">framework</a>, <a href="../../category/wordpress-category/hacking.html">hacking</a>, <a href="../../category/wordpress-category/layers.html">layers</a>, <a href="../../category/wordpress-category/quickies.html">quickies</a>, <a href="../../category/wordpress-category/useability.html">usability</a></li></ul></div><div class="field field-name-taxonomy-vocabulary-7 field-type-taxonomy-term-reference field-label-above clearfix"><h3 class="field-label">Tags: </h3><ul class="links"><li class="taxonomy-term-reference-0"><a href="../../category/wordpress-tag/drupal.html">drupal</a>, <a href="../../category/wordpress-tag/javascript.html">javascript</a>, <a href="../../category/wordpress-tag/form.html">form</a>, <a href="../../category/wordpress-tag/state.html">state</a>, <a href="../../category/wordpress-tag/dynamic.html">dynamic</a></li></ul></div>  </div>
</div>
<div id="block-views-recent-blog-block-1" class="block block-views">

    <h2>Recent blogposts</h2>
  
  <div class="content">
    <div class="view view-recent-blog view-id-recent_blog view-display-id-block_1 view-dom-id-3ce5862e9a662622e68a8b3a8cfb040d">
        
  
  
      <div class="view-content">
        <ul>
    <li class="first odd">
      
      <h3>
  
    
      <a href="../2017-07-21/altering-length-drupal-8-text-field-contains-data.html">Altering the length of a Drupal 8 text field that contains data</a>
      </h3>
  

      <div>
  
    
      Friday, July 21, 2017 - 11:31
      </div>
  
    </li>
      <li class="even">
      
      <h3>
  
    
      <a href="../2017-06-02/menagerie-testing-behavioural-unit-system-smoke-regression-oh-my.html">A menagerie of testing: behavioural, unit, system, smoke, regression, oh my!</a>
      </h3>
  

      <div>
  
    
      Friday, June 2, 2017 - 10:11
      </div>
  
    </li>
      <li class="last odd">
      
      <h3>
  
    
      <a href="../2017-05-30/including-javascript-behat-tests-all-inside-headless-virtual-machine.html">Including Javascript in Behat tests, all inside a headless, virtual machine</a>
      </h3>
  

      <div>
  
    
      Tuesday, May 30, 2017 - 16:51
      </div>
  
    </li>
    </ul>
    </div>
  
  
  
      
<div class="more-link">
  <a href="../../blog_view.html">
    All blogposts  </a>
</div>
  
  
  
</div>  </div>
</div>
<div id="block-block-5" class="block block-block">

    <h2>About me</h2>
  
  <div class="content">
    <p>I'm J-P Stacey, and I'm a freelance technical developer and software architect, working with <a href="http://drupal.org/">Drupal</a>, Javascript, Symfony, PHP and devops, with experience in project and process management and an emphasis on usability.</p>
<p>I live in the <a href="http://gov.uk">UK</a>; my website is self-hosted on <a href="http://bigv.io">bigv.io</a>; my email is hosted by <a href="http://mail.google.com">Google</a>, and that's also what I use to share files. <small>(<a href="https://data-jurisdiction.org/country/GB">More info</a>|<a href="http://www.jpstacey.info/blog/2013-08-20/what-jurisdiction-am-i-in">What is this?</a>)</small></p>
  </div>
</div>
<div id="block-menu-secondary-menu" class="block block-menu">

    <h2>Find me elsewhere</h2>
  
  <div class="content">
    <ul class="menu clearfix"><li class="first leaf"><a href="http://twitter.com/mphield" title="My commercial account on Twitter">Company @ Twitter</a></li>
<li class="leaf"><a href="http://drupal.org/user/130486" title="Drupal user #130486: woohoo!">Drupal @ d.o</a></li>
<li class="leaf"><a href="http://github.com/jpstacey" title="My code repositories on Github">Code @ Github</a></li>
<li class="leaf"><a href="http://flickr.com/photos/eustatius" title="My photos on Flickr">Photos @ Flickr</a></li>
<li class="last leaf"><a href="http://pinboard.in/u:jpstacey" title="My links on the Pinboard bookmarking site">Links @ Pinboard</a></li>
</ul>  </div>
</div>
  </div>
      </div></div> <!-- /.section, /#sidebar-second -->
    
  </div></div> <!-- /#main, /#main-wrapper -->

  
  <div id="footer-wrapper"><div class="section">

    
    
  </div></div> <!-- /.section, /#footer-wrapper -->

</div></div> <!-- /#page, /#page-wrapper -->
  </body>
</html>
